<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="magazineMapper">

	<!-- 매거진 -->
	<resultMap id="magazineResultSet" type="magazine">
		<result column="MAGAZINE_NO" property="magazineNo" />
		<result column="MAGAZINE_TITLE" property="magazineTitle" />
		<result column="MAGAZINE_CONTENT" property="magazineContent" />
		<result column="MAGAZINE_COUNT" property="magazineCount" />
		<result column="MAGAZINE_IMG_NAME" property="magazineImgName" />
		<result column="CATEGORY_NO" property="categoryNo" />	
		<result column="MAGAZINE_STATUS" property="magazineStatus" />	
		<result column="MAGAZINE_HASHTAG" property="magazineHashtag" />	
	</resultMap>	
	
	<!-- 카테고리 -->
	<resultMap id="magazineCategoryResult" type="category">	
		<result column="CATEGORY_NO" property="categoryNo" />
		<result column="CATEGORY_NAME" property="categoryName" />	
	</resultMap>
	
	<!-- 이전글 다음글 -->
	<resultMap id="prePageNextPage" type="magazinePage">
		<result column="MAGAZINE_NO" property="magazineNo" />
		<result column="PRE_NO" property="preNo" />
		<result column="PRE_TITLE" property="preTitle" />
		<result column="NEXT_NO" property="nextNo" />
		<result column="NEXT_TITLE" property="nextTitle" />
	</resultMap>
	
	<!-- 좋아요 -->
	<resultMap id="magazineLikeResultSet" type="magazineLike">
		<result column="MEMBER_NO" property="memberNo" />
		<result column="MAGAZINE_NO" property="magazineNo" />
	</resultMap>
	

	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		  FROM MAGAZINE
		 WHERE MAGAZINE_STATUS = 'Y'
	</select>

	<select id="selectMagazineList" resultMap="magazineResultSet" >
		SELECT MAGAZINE_NO
			 , CATEGORY_NO
		     , MAGAZINE_TITLE
			 , MAGAZINE_IMG_NAME
			 , MAGAZINE_HASHTAG
		  FROM MAGAZINE
		 WHERE MAGAZINE_STATUS = 'Y'
		 ORDER BY MAGAZINE_NO DESC
	</select>

	<insert id="insertMagazine" parameterType="magazine">
		INSERT INTO MAGAZINE (MAGAZINE_NO
							, CATEGORY_NO
						    , MAGAZINE_TITLE
						    , MAGAZINE_CONTENT
						    , MAGAZINE_IMG_NAME
						    , MAGAZINE_HASHTAG)
					  VALUES (SEQ_MAGAZINE_NO.NEXTVAL
							, #{categoryNo}
							, #{magazineTitle}
							, #{magazineContent}
							, #{magazineImgName}
							, #{magazineHashtag})
	</insert>
	
		
	<select id="selectMagazine" resultMap="magazineResultSet" parameterType="_int">
		 SELECT MAGAZINE_NO
			  ,	MAGAZINE_TITLE
			  , MAGAZINE_CONTENT
			  , MAGAZINE_IMG_NAME
			  , MAGAZINE_HASHTAG
			  , CATEGORY_NAME AS "CATEGORY_NO"
		   FROM MAGAZINE
		   JOIN CATEGORY USING (CATEGORY_NO)
		  WHERE MAGAZINE_NO = #{magazineNo}
			  
	</select>
	
	<update id="deleteMagazine" parameterType="_int">
		UPDATE MAGAZINE
		   SET MAGAZINE_STATUS = 'N'
		 WHERE MAGAZINE_NO = #{magazineNo}
	</update>
	
	<update id="updateMagazine" parameterType="magazine">
		UPDATE MAGAZINE
		   SET CATEGORY_NO = #{categoryNo}
		     , MAGAZINE_TITLE = #{magazineTitle}
		     , MAGAZINE_CONTENT = #{magazineContent}
		     , MAGAZINE_IMG_NAME = #{magazineImgName}
		     , MAGAZINE_HASHTAG = #{magazineHashtag}
		 WHERE MAGAZINE_NO = #{magazineNo}
	</update>
	
	<!-- 이전글 다음글 -->
	<select id="magazinePage" resultMap="prePageNextPage" parameterType="_int">
		SELECT RESULT.*
		FROM
   			(SELECT MAGAZINE_NO,
		            LAG(MAGAZINE_NO, 1, 9999) OVER (ORDER BY MAGAZINE_NO DESC) PRENO,
		            LEAD(MAGAZINE_NO, 1, 9999) OVER (ORDER BY MAGAZINE_NO DESC) NEXTNO,
		            MAGAZINE_TITLE,
		            LAG(MAGAZINE_TITLE, 1, 9999) OVER (ORDER BY MAGAZINE_NO DESC) PRETITLE,
		            LEAD(MAGAZINE_TITLE, 1, 9999) OVER (ORDER BY MAGAZINE_NO DESC) NEXTTITLE
		            FROM MAGAZINE
		            WHERE MAGAZINE_STATUS = 'Y'
		            ORDER BY MAGAZINE_NO DESC) RESULT
		WHERE MAGAZINE_NO = #{magazineNo}
		
	</select>

	<!-- 조회수  -->
	<update id="updateViewCount" parameterType="_int">
		UPDATE MAGAZINE
		   SET MAGAZINE_COUNT = MAGAZINE_COUNT + 1
		 WHERE MAGAZINE_NO = #{magazineNo}
	</update>

	<!-- 카테고리 -->
	<select id="categoryView" resultMap="magazineCategoryResult" parameterType="magazine">
		SELECT MAGAZINE_TITLE
		     , MAGAZINE_CONTENT
		     , MAGAZINE_COUNT
		     , MAGAZINE_IMG_NAME
		     , CATEGORY_NAME
		     , MAGAZINE_HASHTAG
	      FROM MAGAZINE 
		  JOIN CATEGORY USING (CATEGORY_NO)
		 WHERE MAGAZINE_STATUS= 'Y'
		   AND CATEGORY_NO = #{categoryNo}
		 ORDER BY MAGAZINE_NO DESC
	</select>
	
	<!-- 최신순/인기순 -->
	<select id="selectPopularList" resultMap="magazineResultSet">
		SELECT *
		FROM(SELECT ROWNUM RNUM, M.*
	         FROM(SELECT CATEGORY_NAME
	                   , MAGAZINE_NO
	                   , MAGAZINE_COUNT
	                   , MAGAZINE_IMG_NAME
	                   , MAGAZINE_TITLE
	                   , MAGAZINE_HASHTAG
	                FROM MAGAZINE
	                JOIN CATEGORY USING (CATEGORY_NO)
	               WHERE MAGAZINE_STATUS= 'Y'
	            ORDER BY MAGAZINE_NO DESC) M)
	    <choose>
			<when test="order == 'new'">
				ORDER BY MAGAZINE_NO DESC
			</when>
			<when test="order == 'popular'">
				ORDER BY MAGAZINE_COUNT DESC
			</when>
		</choose>
	</select>
	

</mapper>